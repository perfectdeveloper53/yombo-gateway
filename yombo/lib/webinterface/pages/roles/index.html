{% extends "lib/webinterface/fragments/layout.tpl" %}
{% block head_css %}{% include 'lib/webinterface/fragments/datatables_css.tpl' %}{% endblock %}

{% block content %}
<!-- Modal -->
<div class="modal fade" id="localModal" tabindex="-1" role="dialog" aria-labelledby="localModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Roles</h4>
      </div>
      <div class="modal-body">
          <p>Yombo uses a Role Base Access Control (RBAC) system. This easy to use system allows fine grain control
              to users. For example, parents can control anything within the system, however, childen can only
              control devices but cannot edit or define them.
          </p>
          <p>
              When adding new users, you'll generally add them to the 'General Users' role so that they can view and
              control devices.
          </p>
          <p>
              For moire details, see: LINK COMING SOON.
          </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">{{ _('webinterface_label', 'Roles') }}
        <a href="#" data-toggle=modal data-target=#localModal><i class="fa fa-question pull-right"></i></a></h1>
        <p></p>
    </div>
    <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <a href="/roles/add" class="btn btn-md btn-primary pull-right">Add Role</a>
                <label>Defined roles</label>
                <br>&nbsp;
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div class="dataTable_wrapper">
                    <table width="100%" class="table table-striped table-bordered table-hover" id="roles">
                        <thead>
                            <tr>
                                <th>Label<br>Description</th><th>Members</th><th>Permissions</th></th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>{% for label, role in _users.roles.items() %}
                             <tr>
                                <td data-priority="1" style="max-width: 10em;">
                                    <p><strong>Label:</strong><br>{{ role.label }}</p>
                                    <p><strong>Decription:</strong><br>{{ role.description }}</p>
                                </td>
                                <td data-priority="3">
                                    {%- set role_members = _users.list_roles_by_user() %}
                                    {%- if role_members[label]|length > 0 %}
                                    <strong>Users</strong>
                                    <ul>
                                    {% for member in role_members[label] %}
                                        <li>{{ member.name }} &lt;{{member.email}}&gt;</li>
                                    {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {%- set role_members = role.auth_keys %}
                                    {%- if role_members|length > 0 %}
                                    <strong>Auth Keys</strong>
                                    <ul>
                                    {% for member in role_members %}
                                        <li>{{member.label}}</li>
                                    {% endfor %}
                                    </ul>
                                    {% endif %}
                                </td>
                                <td>
                                    {%- if role.permissions['allow']|length > 0 %}
                                    <strong>Allow</strong>
                                    <ul>
                                    {% for permission in role.permissions['allow'] %}
                                        <li>{{permission[0]}} <i class="fas fa-arrow-right"></i> {{permission[1]}}</li>
                                    {% endfor %}
                                    </ul>
                                    {% endif %}
                                    {%- if role.permissions['deny']|length > 0 %}
                                    <strong>Deny</strong>
                                    <ul>
                                    {% for permission in role.permissions['deny'] %}
                                        <li>{{permission[0]}} <i class="fas fa-arrow-right"></i> {{permission[1]}}</li>
                                    {% endfor %}
                                    </ul>
                                    {% endif %}
                                </td>
                                <td style="max-width: 10px;">
                                        <a href="/roles/{{ role.role_id }}/details">Details</a>
                                    {%- if role.role_type == "database" %}
                                        <a class="alert-warning" href="/roles/{{ role.role_id }}/remove">Remove</a>
                                    {%- endif %}
                                </td>
                             </tr>{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            </div>
        </div>
        <!-- /.panel-body -->
    </div>
    <!-- /.col-lg-6 -->
</div>
<!-- /.row -->
{% endblock %}

{% block body_bottom_js %}{% include 'lib/webinterface/fragments/datatables_js.tpl' %}{% endblock %}

{% block body_bottom %}
    <!-- Make the tables pretty -->
    <script>
    $(document).ready(function() {
        $('#roles').DataTable({
                responsive: true,
                paging: true,
                iDisplayLength: 50,
                "aoColumnDefs": [
                      { "bSearchable": false, "aTargets": [ 3 ] }
                    ]
        });

    });
    </script>
{% endblock %}
